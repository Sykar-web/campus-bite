<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Campus Bite ‚Äì Community</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
  body { background:#fff8f1; color:#333; }
  header { background:#ff914d; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
  header h1 { font-size:1.3rem; font-weight:600; }
  header button { background:#fff; color:#ff914d; border:none; border-radius:8px; padding:6px 12px; cursor:pointer; font-weight:600; transition:0.3s; }
  header button:hover{ background:#ffd6ba; }

  .comment-section { padding:20px; margin-top:20px; }
  .comment-section h2 { color:#ff6a00; margin-bottom:15px; }
  .comment-card { background:#fff; padding:12px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .comment-card p { margin-bottom:6px; }
  .reply-section { margin-left:20px; margin-top:10px; }
  .reply-form { display:flex; gap:6px; margin-top:10px; }
  .reply-form input { flex:1; padding:6px 8px; border-radius:6px; border:1px solid #ccc; font-size:0.85rem; }
  .reply-form button { padding:6px 10px; background:#ff914d; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; }
  .reply-form button:hover { background:#ff6a00; }
  .like-btn { margin-right:10px; cursor:pointer; padding:4px 8px; border-radius:6px; border:none; }
  .liked { background:#ffd6ba; }
  .disliked { background:#ccc; }

  footer { text-align:center; padding:15px; font-size:0.9rem; background:#fff8f1; color:#777; margin-top:20px; }
</style>
</head>
<body>

<header>
 <h1>Community üí¨</h1>
 <button onclick="window.location.href='home.html'">Back to Home</button>
</header>

<section class="comment-section">
  <h2>All Comments</h2>
  <div id="commentsContainer"></div>
</section>

<footer>¬© 2025 Campus Bite. All rights reserved.<br>Muni University | Arua Uganda</footer>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyATGWLqyjWJUaDXwudubIc_Hvh5yPVDyOI",
  authDomain: "campus-bite-9dbaa.firebaseapp.com",
  projectId: "campus-bite-9dbaa",
  storageBucket: "campus-bite-9dbaa.appspot.com",
  messagingSenderId: "294389261625",
  appId: "1:294389261625:web:095d6e5f85f4e8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUserName = "";

// ---------------- USER ----------------
auth.onAuthStateChanged(user=>{
  if(!user) window.location.href="index.html";
  else {
    db.collection("students").doc(user.uid).get().then(doc=>{
      if(doc.exists){
        currentUserName = doc.data().name;
      }
    });
  }
});

// ---------------- REPLIES ----------------
function showReplyForm(buttonElem, parentId, parentType, replyId){
    const parentDiv = buttonElem.closest(".comment-card");
    if(parentDiv.querySelector(".reply-form")) return; // already open

    const form = document.createElement("div");
    form.className = "reply-form";
    form.innerHTML = `<input type='text' placeholder='Write a reply...' required>
                      <button>Reply</button>`;
    form.querySelector("button").addEventListener("click", async ()=>{
        const text = form.querySelector("input").value.trim();
        if(!text) return;
        const user = auth.currentUser;
        if(!user) return alert("You must be logged in!");
        let parentRef = db.collection("comments").doc(parentId);
        if(parentType==="replies") parentRef = parentRef.collection("replies").doc(replyId);
        await parentRef.collection("replies").add({
            userId: user.uid,
            userName: currentUserName,
            text,
            likes: [],
            dislikes: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        form.querySelector("input").value="";
    });
    parentDiv.appendChild(form);
}

// ---------------- LIKE/DISLIKE ----------------
async function toggleReaction(commentId, parentType, replyId, type){
    const user = auth.currentUser;
    if(!user) return;
    const uid = user.uid;
    let ref = db.collection("comments").doc(commentId);
    if(parentType==="replies") ref = ref.collection("replies").doc(replyId);
    const docSnap = await ref.get();
    if(!docSnap.exists) return;
    let {likes=[], dislikes=[]} = docSnap.data();
    if(type==="like"){
        if(likes.includes(uid)) likes = likes.filter(id=>id!==uid);
        else{ likes.push(uid); dislikes = dislikes.filter(id=>id!==uid); }
    } else {
        if(dislikes.includes(uid)) dislikes = dislikes.filter(id=>id!==uid);
        else{ dislikes.push(uid); likes = likes.filter(id=>id!==uid); }
    }
    await ref.update({likes, dislikes});
}

// ---------------- RENDER COMMENTS ----------------
async function renderReplies(commentRef, container){
    const snapshot = await commentRef.collection("replies").orderBy("createdAt","asc").get();
    for(const doc of snapshot.docs){
        const data = doc.data();
        const replyId = doc.id;
        const uid = auth.currentUser ? auth.currentUser.uid : "";
        const liked = data.likes.includes(uid);
        const disliked = data.dislikes.includes(uid);

        const div = document.createElement("div");
        div.className = "comment-card reply-section";
        div.innerHTML = `
          <p><strong>${data.userName}</strong></p>
          <p>${data.text}</p>
          <p>
            <button class="like-btn ${liked?'liked':''}" onclick="toggleReaction('${commentRef.id}','replies','${replyId}','like')">üëç ${data.likes.length}</button>
            <button class="like-btn ${disliked?'disliked':''}" onclick="toggleReaction('${commentRef.id}','replies','${replyId}','dislike')">üëé ${data.dislikes.length}</button>
            <button onclick="showReplyForm(this,'${commentRef.id}','replies','${replyId}')">Reply</button>
          </p>
        `;
        container.appendChild(div);
        await renderReplies(commentRef.collection("replies").doc(replyId), div);
    }
}

db.collection("comments").orderBy("createdAt","desc").onSnapshot(async snapshot=>{
    const container = document.getElementById("commentsContainer");
    container.innerHTML = "";
    for(const doc of snapshot.docs){
        const data = doc.data();
        const commentId = doc.id;
        const uid = auth.currentUser ? auth.currentUser.uid : "";
        const liked = data.likes.includes(uid);
        const disliked = data.dislikes.includes(uid);

        const div = document.createElement("div");
        div.className = "comment-card";
        div.innerHTML = `
          <p><strong>${data.userName}</strong></p>
          <p>${data.text}</p>
          <p>
            <button class="like-btn ${liked?'liked':''}" onclick="toggleReaction('${commentId}','comment','','like')">üëç ${data.likes.length}</button>
            <button class="like-btn ${disliked?'disliked':''}" onclick="toggleReaction('${commentId}','comment','','dislike')">üëé ${data.dislikes.length}</button>
            <button onclick="showReplyForm(this,'${commentId}','comment','')">Reply</button>
          </p>
        `;
        container.appendChild(div);
        await renderReplies(db.collection("comments").doc(commentId), div);
    }
});
</script>
</body>
</html>
